#!/bin/bash
set -e

env_required!() {
    local var_name="$1"
    local var_value="${!var_name}"

    if [ -z "$var_value" ]; then
        echo "âŒ $var_name environment variable is not set"
        exit 1
    fi
}

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FRONTEND_DIR="$SCRIPT_DIR/../frontend"

if [ -f "$SCRIPT_DIR/.env" ]; then
    echo "ğŸ“„ Loading .env file"
    set -a
    source "$SCRIPT_DIR/.env"
    set +a
fi

echo "ğŸš€ Deploying frontend"

env_required! "CLOUDFLARE_API_TOKEN"
env_required! "CLOUDFLARE_ACCOUNT_ID"

if ! command -v pnpm &> /dev/null; then
    echo "âŒ pnpm is not installed. Please install it first."
    exit 1
fi

cd $FRONTEND_DIR

echo "ğŸ“¦ Installing dependencies"
pnpm install --frozen-lockfile

echo "ğŸ”¨ Building frontend"
pnpm build

echo "â˜ï¸ Deploying to Cloudflare Pages"
pnpm run wrangler pages deploy dist --project-name=wof